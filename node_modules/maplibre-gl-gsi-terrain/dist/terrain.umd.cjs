(function(i,c){typeof exports=="object"&&typeof module<"u"?c(exports):typeof define=="function"&&define.amd?define(["exports"],c):(i=typeof globalThis<"u"?globalThis:i||self,c(i.terrain={}))})(this,function(i){"use strict";const c=`
function gsidem2terrarium(r, g, b) {
	let rgb = (r << 16) + (g << 8) + b;
	let h = 0;
	if (rgb < 0x800000) h = rgb * 0.01;
	else if (rgb > 0x800000) h = (rgb - Math.pow(2, 24)) * 0.01;
	const value = h + 32768;
	const tR = Math.floor(value / 256);
	const tG = Math.floor(value) % 256;
	const tB = Math.floor((value - Math.floor(value)) * 256);
	return [tR, tG, tB];
}

self.onmessage = async (e) => {
	const { imageBitmap, id } = e.data;
	const canvas = new OffscreenCanvas(imageBitmap.width, imageBitmap.height);
	const context = canvas.getContext('2d', { willReadFrequently: true });

	// \u7121\u52B9\u5024\u306E\u30D5\u30A9\u30FC\u30EB\u30D0\u30C3\u30AF\u7528\u306B\u80CC\u666F\u3092\u5857\u308A\u3064\u3076\u3059
	context.fillStyle = 'rgb(128,0,0)';
	context.fillRect(0, 0, canvas.width, canvas.height);

	context.drawImage(imageBitmap, 0, 0);
	imageBitmap.close();

	const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
	for (let i = 0; i < imageData.data.length / 4; i++) {
		const tRGB = gsidem2terrarium(
			imageData.data[i * 4],
			imageData.data[i * 4 + 1],
			imageData.data[i * 4 + 2],
		);
		imageData.data[i * 4] = tRGB[0];
		imageData.data[i * 4 + 1] = tRGB[1];
		imageData.data[i * 4 + 2] = tRGB[2];
	}
	context.putImageData(imageData, 0, 0);

	const blob = await canvas.convertToBlob({ type: 'image/png' });
	const arrayBuffer = await blob.arrayBuffer();
	const png = new Uint8Array(arrayBuffer);
	self.postMessage({ png, id }, [png.buffer]);
};
`;let u=null,f=0;const l=new Map;function p(){if(!u){const r=new Blob([c],{type:"application/javascript"});u=new Worker(URL.createObjectURL(r)),u.onmessage=t=>{const{png:a,id:e}=t.data,n=l.get(e);n&&(n.resolve(a),l.delete(e))},u.onerror=t=>{l.forEach(a=>a.reject(new Error(t.message))),l.clear()}}return u}async function h(r){const t=await fetch(r);if(!t.ok)throw new Error(`Failed to fetch: ${t.status}`);const a=await t.blob(),e=await createImageBitmap(a);return new Promise((n,o)=>{const s=f++;l.set(s,{resolve:n,reject:o}),p().postMessage({imageBitmap:e,id:s},[e])})}function b(r,t,a){let e=(r<<16)+(t<<8)+a,n=0;e<8388608?n=e*.01:e>8388608&&(n=(e-Math.pow(2,24))*.01);const o=n+32768,s=Math.floor(o/256),g=Math.floor(o)%256,m=Math.floor((o-Math.floor(o))*256);return[s,g,m]}const w=(r,t={})=>{var o,s,g,m;const a="gsidem",e=d(a);return r(a,e),{type:"raster-dem",encoding:"terrarium",tiles:[`gsidem://${(o=t.tileUrl)!=null?o:"https://cyberjapandata.gsi.go.jp/xyz/dem_png/{z}/{x}/{y}.png"}`],tileSize:256,minzoom:(s=t.minzoom)!=null?s:1,maxzoom:(g=t.maxzoom)!=null?g:14,attribution:(m=t.attribution)!=null?m:""}},d=r=>async(t,a)=>{const e=t.url.replace(`${r}://`,"");return{data:await h(e).catch(o=>{throw a.abort(),o.message})}};i.getGsiDemProtocolAction=d,i.gsidem2terrarium=b,i.useGsiTerrainSource=w,Object.defineProperties(i,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
